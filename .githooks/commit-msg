#!/bin/bash
#
# Commit message hook for go-dependency-injector
# Validates commit messages follow Conventional Commits format
#
# Format: <type>(<scope>): <subject>
#
# Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert
#

set -e

YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if [[ "$COMMIT_MSG" =~ ^Merge ]]; then
    exit 0
fi

# Skip fixup/squash commits
if [[ "$COMMIT_MSG" =~ ^(fixup|squash)! ]]; then
    exit 0
fi

# Conventional commit pattern
# type(scope): subject
# type: subject
PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\([a-zA-Z0-9_-]+\))?: .{1,}"

if ! echo "$COMMIT_MSG" | head -1 | grep -qE "$PATTERN"; then
    echo -e "${RED}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║                    INVALID COMMIT MESSAGE                    ║${NC}"
    echo -e "${RED}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}Your commit message:${NC}"
    echo -e "  \"$(head -1 "$COMMIT_MSG_FILE")\""
    echo ""
    echo -e "${CYAN}Expected format:${NC}"
    echo -e "  ${GREEN}<type>(<scope>): <subject>${NC}"
    echo -e "  ${GREEN}<type>: <subject>${NC}"
    echo ""
    echo -e "${CYAN}Valid types:${NC}"
    echo -e "  ${GREEN}feat${NC}     - A new feature"
    echo -e "  ${GREEN}fix${NC}      - A bug fix"
    echo -e "  ${GREEN}docs${NC}     - Documentation changes"
    echo -e "  ${GREEN}style${NC}    - Formatting, whitespace (no code change)"
    echo -e "  ${GREEN}refactor${NC} - Code restructuring (no behavior change)"
    echo -e "  ${GREEN}test${NC}     - Adding or updating tests"
    echo -e "  ${GREEN}chore${NC}    - Maintenance, dependencies, configs"
    echo -e "  ${GREEN}perf${NC}     - Performance improvements"
    echo -e "  ${GREEN}ci${NC}       - CI/CD changes"
    echo -e "  ${GREEN}build${NC}    - Build system changes"
    echo -e "  ${GREEN}revert${NC}   - Reverting a previous commit"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  feat(auth): add JWT token refresh"
    echo -e "  fix(api): resolve null pointer exception"
    echo -e "  docs: update README installation steps"
    echo -e "  test(container): add circular dependency tests"
    echo -e "  chore(deps): upgrade to Go 1.22"
    echo ""
    exit 1
fi

# Check subject line length (max 72 characters)
SUBJECT_LENGTH=$(echo "$COMMIT_MSG" | head -1 | wc -c)
if [[ $SUBJECT_LENGTH -gt 73 ]]; then
    echo -e "${RED}Error: Commit subject line exceeds 72 characters ($SUBJECT_LENGTH chars)${NC}"
    echo -e "${YELLOW}Please shorten your commit message subject.${NC}"
    exit 1
fi

# Check that subject doesn't end with a period
if echo "$COMMIT_MSG" | head -1 | grep -qE '\.$'; then
    echo -e "${RED}Error: Commit subject should not end with a period${NC}"
    exit 1
fi

# Check that subject starts with lowercase after the colon
SUBJECT=$(echo "$COMMIT_MSG" | head -1 | sed 's/^[^:]*: //')
FIRST_CHAR=$(echo "$SUBJECT" | cut -c1)
if [[ "$FIRST_CHAR" =~ [A-Z] ]]; then
    echo -e "${YELLOW}Warning: Consider starting subject with lowercase: '${SUBJECT}'${NC}"
    # This is a warning, not an error - don't exit
fi

echo -e "${GREEN}✓ Commit message is valid${NC}"
exit 0


