#!/bin/bash
#
# Pre-push hook for go-dependency-injector
# Runs comprehensive checks before allowing a push
#

set -e

YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${YELLOW}Running pre-push checks...${NC}"

# Check if Go is installed
if ! command -v go &> /dev/null; then
    echo -e "${RED}Error: Go is not installed${NC}"
    exit 1
fi

# 1. Ensure go.mod is tidy
echo -e "\n${YELLOW}[1/4] Checking go.mod...${NC}"
cp go.mod go.mod.backup
cp go.sum go.sum.backup 2>/dev/null || true
go mod tidy
if ! diff -q go.mod go.mod.backup > /dev/null 2>&1; then
    echo -e "${RED}go.mod is not tidy. Run 'go mod tidy' and commit the changes.${NC}"
    mv go.mod.backup go.mod
    mv go.sum.backup go.sum 2>/dev/null || true
    exit 1
fi
rm go.mod.backup
rm go.sum.backup 2>/dev/null || true
echo -e "${GREEN}✓ go.mod is tidy${NC}"

# 2. Run go vet
echo -e "\n${YELLOW}[2/4] Running go vet...${NC}"
if ! go vet ./... 2>&1; then
    echo -e "${RED}go vet found issues${NC}"
    exit 1
fi
echo -e "${GREEN}✓ go vet passed${NC}"

# 3. Build check
echo -e "\n${YELLOW}[3/4] Checking build...${NC}"
if ! go build ./... 2>&1; then
    echo -e "${RED}Build failed${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Build successful${NC}"

# 4. Run full test suite
echo -e "\n${YELLOW}[4/4] Running full test suite...${NC}"
if ! go test -race -cover ./... 2>&1; then
    echo -e "${RED}Tests failed${NC}"
    exit 1
fi
echo -e "${GREEN}✓ All tests passed${NC}"

# Optional: Run golangci-lint if available
if command -v golangci-lint &> /dev/null; then
    echo -e "\n${YELLOW}[Bonus] Running golangci-lint...${NC}"
    if ! golangci-lint run ./... 2>&1; then
        echo -e "${RED}Linting failed${NC}"
        exit 1
    fi
    echo -e "${GREEN}✓ Linting passed${NC}"
fi

echo -e "\n${GREEN}All pre-push checks passed! Pushing...${NC}"
exit 0

